<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/css/estilos.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <h1>Cadastro de Professores</h1>

    <form th:action="@{/professores/salvar}" th:object="${professor}" method="post">
        <input type="hidden" name="idPessoa" th:field="*{idPessoa}" readonly />
 
        <label for="nomePessoa">Nome:</label>
        <input type="text" id="nomePessoa" name="nomePessoa" th:field="*{nomePessoa}" required />
        <br />

        <label for="telefoneProfessor">Telefone:</label>
        <input type="text" id="telefoneProfessor" name="telefoneProfessor" th:field="*{telefoneProfessor}" />
        <br />

        <label for="dataAdmissao">Data Admissão:</label>
        <input type="text" id="dataAdmissao" name="dataAdmissao" th:field="*{dataAdmissao}" />
        <br />

        <label for="formacao">Formação:</label>
        <input type="text" id="formacao" name="formacao" th:field="*{formacao}" />
        <br />

        <label for="cpfProfessor">CPF:</label>
        <input type="text" id="cpfProfessor" name="cpfProfessor" th:field="*{cpfProfessor}" />
        <br />

        <label for="status">Status:</label>
        <select name="status" id="status" th:field="*{status}" required>
            <option value="">Selecione um status</option>
            <option value="ATIVO" th:selected="${professor.status == 'ATIVO'}">ATIVO</option>
            <option value="INATIVO" th:selected="${professor.status == 'INATIVO'}">INATIVO</option>
            <option value="LICENÇA" th:selected="${professor.status == 'LICENÇA'}">LICENÇA</option>
        </select>
        <br />

        <label for="estados">Estado: *</label>
        <select id="estados" disabled>
            <option value="">Carregando estados...</option>
        </select>
        <br />

        <label for="cidades">Cidade: *</label>
        <select id="cidades" disabled>
            <option value="">Selecione um estado primeiro</option>
        </select>
        <br />

        <!-- Campos ocultos que serão enviados no formulário -->
        <input type="hidden" name="cidade.idCidade" id="cidadeIdSelecionada" 
               th:value="${professor.cidade != null ? professor.cidade.idCidade : ''}" />
        <input type="hidden" name="cidade.nomeCidade" id="cidadeNomeSelecionada" 
               th:value="${professor.cidade != null ? professor.cidade.nomeCidade : ''}" />

        <button type="submit">Salvar</button>
    </form>

    <table>
        <a href="/home">Voltar</a>
    </table>
    

    <script th:inline="javascript">
        const estadosSelect = document.getElementById('estados');
        const cidadesSelect = document.getElementById('cidades');
        const IBGE_BASE = 'https://servicodados.ibge.gov.br/api/v1/localidades';

        // Pega os dados da cidade atual (quando está editando)
        const cidadeAtual = {
            id: /*[[${professor.cidade != null ? professor.cidade.idCidade : null}]]*/ null,
            nome: /*[[${professor.cidade != null ? professor.cidade.nomeCidade : ''}]]*/ ''
        };

        // Carrega todos os estados do Brasil
        async function carregarEstados() {
            try {
                const res = await fetch(`${IBGE_BASE}/estados?orderBy=nome`);
                if (!res.ok) throw new Error('Erro ao buscar estados');
                const dados = await res.json();

                estadosSelect.innerHTML = '<option value="">Selecione um estado</option>';
                dados.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id;
                    opt.textContent = s.nome;
                    estadosSelect.appendChild(opt);
                });

                // ✅ CORREÇÃO PRINCIPAL: Habilita o select de estados
                estadosSelect.disabled = false;

                // Se está editando um aluno, busca o estado da cidade
                if (cidadeAtual.id) {
                    await buscarEstadoDaCidade(cidadeAtual.id);
                }
            } catch (err) {
                estadosSelect.innerHTML = '<option value="">Erro ao carregar estados</option>';
                console.error('Erro:', err);
                alert('Não foi possível carregar os estados. Verifique sua conexão com a internet.');
            }
        }

        // Busca qual é o estado de uma cidade específica (para modo edição)
        async function buscarEstadoDaCidade(cidadeId) {
            try {
                const res = await fetch(`${IBGE_BASE}/municipios/${cidadeId}`);
                if (!res.ok) return;
                const cidade = await res.json();

                // Acessa o estado através da estrutura do IBGE
                const estadoId = cidade?.microrregiao?.mesorregiao?.UF?.id;
                if (!estadoId) {
                    console.error('Não foi possível encontrar o estado da cidade');
                    return;
                }

                // Seleciona o estado
                estadosSelect.value = estadoId;

                // Carrega as cidades desse estado
                await carregarCidadesPorEstado(estadoId);

                // Seleciona a cidade atual (após as options terem sido criadas)
                cidadesSelect.value = cidadeId;

                // Preenche os campos ocultos
                document.getElementById('cidadeIdSelecionada').value = cidadeId;
                document.getElementById('cidadeNomeSelecionada').value = cidade.nome || cidadeAtual.nome;
            } catch (err) {
                console.error('Erro ao buscar estado da cidade:', err);
            }
        }

        // Carrega as cidades por estado
        async function carregarCidadesPorEstado(estadoId) {
            try {
                cidadesSelect.innerHTML = '<option value="">Carregando cidades...</option>';
                cidadesSelect.disabled = true;

                const res = await fetch(`${IBGE_BASE}/estados/${estadoId}/municipios?orderBy=nome`);
                if (!res.ok) throw new Error('Erro ao buscar cidades');
                const dados = await res.json();

                cidadesSelect.innerHTML = '<option value="">Selecione uma cidade</option>';
                dados.forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m.id;
                    opt.textContent = m.nome;
                    cidadesSelect.appendChild(opt);
                });
                cidadesSelect.disabled = false;
            } catch (err) {
                cidadesSelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
                cidadesSelect.disabled = true;
                console.error('Erro:', err);
                alert('Não foi possível carregar as cidades. Tente novamente.');
            }
        }

        // Quando o usuário seleciona um estado
        estadosSelect.addEventListener('change', (e) => {
            const estadoId = e.target.value;
            if (!estadoId) {
                cidadesSelect.innerHTML = '<option value="">Selecione um estado primeiro</option>';
                cidadesSelect.disabled = true;
                // Limpa os campos ocultos
                document.getElementById('cidadeIdSelecionada').value = '';
                document.getElementById('cidadeNomeSelecionada').value = '';
                return;
            }
            carregarCidadesPorEstado(estadoId);
        });

        // Quando o usuário seleciona uma cidade
        cidadesSelect.addEventListener('change', (e) => {
            const cidadeId = e.target.value;
            const cidadeNome = e.target.options[e.target.selectedIndex]?.text || '';

            // Preenche os campos ocultos que serão enviados no formulário
            document.getElementById('cidadeIdSelecionada').value = cidadeId;
            document.getElementById('cidadeNomeSelecionada').value = cidadeNome;
        });

        // Validação antes de enviar o formulário
        document.querySelector('form').addEventListener('submit', function(e) {
            const cidadeId = document.getElementById('cidadeIdSelecionada').value;
            if (!cidadeId) {
                e.preventDefault();
                alert('Por favor, selecione o estado e a cidade antes de salvar.');
                return false;
            }
        });

        // Inicia o carregamento quando a página carregar
        carregarEstados();
    </script>
</body>
</html>